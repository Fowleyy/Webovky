@model Semestralka.Models.Calendar
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor

@{
    ViewData["Title"] = "Kalend√°≈ô";

    var currentUserId = HttpContextAccessor.HttpContext.Session.GetString("userid");
    bool isOwner = (currentUserId != null && Model.OwnerId.ToString() == currentUserId);

    // Najdeme permission pro sd√≠len√≠
    string permission = "read";
    if (!isOwner)
    {
        var share = Model.SharedWith?.FirstOrDefault(s => s.UserId.ToString() == currentUserId);
        if (share != null)
            permission = share.Permission;
    }

    bool canEdit = isOwner || permission == "edit";
}

<!-- HEADER -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="fw-bold">
        @Model.Title
        <span class="text-muted" style="font-size: 16px;">
            @if (isOwner)
            {
                <text>(M≈Øj kalend√°≈ô)</text>
            }
            else
            {
                <text>(Sd√≠len√Ω kalend√°≈ô ‚Äì @Model.Owner.FullName)</text>
            }
        </span>
    </h2>

    <div class="d-flex gap-2">
        <button id="cal-day" class="btn btn-outline-purple">Den</button>
        <button id="cal-week" class="btn btn-outline-purple">T√Ωden</button>
        <button id="cal-month" class="btn btn-purple">Mƒõs√≠c</button>

        <!-- Tlaƒç√≠tko sd√≠len√≠ pro vlastn√≠ka -->
        @if (isOwner)
        {
            <a class="btn btn-outline-primary" href="/calendar/share/@Model.Id">ü§ù Sd√≠let</a>
        }
    </div>
</div>

<!-- FULLCALENDAR -->
<div id="calendar" class="mb-4"></div>

<!-- FullCalendar scripts -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', async function () {

    var calendarEl = document.getElementById('calendar');

    async function loadEvents() {
        const res = await fetch('/api/events?calendarId=@Model.Id');
        if (!res.ok) return [];
        return await res.json();
    }

    var calendar = new FullCalendar.Calendar(calendarEl, {
        headerToolbar: false,
        initialView: "dayGridMonth",

        events: async (info, success) => {
            const evs = await loadEvents();
            success(evs);
        },

        // ==== CREATE EVENT ====
        @if (canEdit)
        {
            <text>
            dateClick: function(info) {
                window.location.href = '/event/create/@Model.Id?start=' + info.dateStr;
            },
            </text>
        }

        // ==== VIEW/EDIT EVENT ====
        @if (canEdit)
        {
            <text>
            eventClick: function(info) {
                window.location.href = '/event/edit/' + info.event.id;
            }
            </text>
        }
    });

    calendar.render();

    // Change view buttons
    document.getElementById("cal-month").onclick = () => calendar.changeView("dayGridMonth");
    document.getElementById("cal-week").onclick = () => calendar.changeView("timeGridWeek");
    document.getElementById("cal-day").onclick = () => calendar.changeView("timeGridDay");
});
</script>
